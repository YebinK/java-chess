<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="./chessStyle.css" rel="stylesheet" type="text/css"/>
    <title>엘리의 크리스마스 체스</title>
</head>

<body>
<div id="gameUI">
    <h1 id="title">크리스마스 체스</h1>
    <div id="chessBoard">
        {{#chessPieces}}
        <div id="{{position}}" class="tile">
            {{#if piece}}
            <img alt="position" class="tileImage" src="./images/{{piece}}.png"/>
            {{else}}
            <img alt="empty" src="./images/blank.png"/>
            {{/if}}
        </div>
        {{/chessPieces}}
    </div>

    <div id="commandUI">
        <div id="current_team"> 현재 차례 : {{currentTeam}}팀</div>
        {{#if score}}
        <div id="chess_score">{{currentTeam}}팀의 점수는 {{score}}점 입니다.</div>
        {{/if}}

        {{#if winner}}
        <div id="chess_winner">{{winner}}팀이 우승했습니다. 게임 끝~</div>
        {{else}}

        {{#if error}}
        <div id="move_error" class="error">{{error}}</div>
        {{/if}}
        <form action="/status" method="post">
            <button id="status_button" name="status" type="submit">STATUS</button>
        </form>
        <br/>
        <form action="/move" method="post">
            <input id="move_input" name="move_cmd"/>
            <button id="move_button" type="submit">MOVE</button>
        </form>
        {{/if}}

        <form action="/end" method="get">
            <button>종료하기</button>
        </form>
    </div>
</div>
</body>

<script>
    let source = null;
    let target = null;

    const tiles = document.getElementsByClassName("tile");
    for (i = 0; i < tiles.length; i++) {
        tiles.item(i).addEventListener("click", function () {
            changeOpacity(this);
            checkSourceOrTarget(this.id);
        })
    }

    function checkSourceOrTarget(clickedPosition) {
        if (source == null) {
            source = clickedPosition;
            return;
        }
        if (source === clickedPosition) {
            source = null;
        }
        if (target == null) {
            target = clickedPosition;
            move(source, target);
        }
    }

    function move(source, target) {
        const moveInformation = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'source': source,
                'target': target
            }
        };
        fetch("/move", moveInformation)
            .then(() => {
                window.location = "http://localhost:4567/move";
            }).catch(error => {
            console.log("이동할 수 없습니다." + error);
        });
        initialize();
    }

    function changeOpacity(clickedPosition) {
        clickedPosition.style.opacity = "0.7";
    }

    function initialize() {
        source = null;
        target = null;
    }
</script>
</html>